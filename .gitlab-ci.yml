---
stages:
  - build
  - deploy

variables:
  PROJECT_ID: $GCLOUD_PROJECT_ID
  GOOGLE_APPLICATION_CREDENTIALS: $GCLOUD_SERVICE_KEY_FILE
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE_NAME: $DOCKER_USERNAME/serverless-frontend

build:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  script:
    - cd frontend
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    - docker build -t -t $DOCKER_IMAGE_NAME:latest .
    - docker push $DOCKER_IMAGE_NAME:latest
  after_script:
    - docker system prune -f
    - docker image prune -f
  only:
    - dev

deploy:
  image: google/cloud-sdk:slim
  stage: deploy
  dependencies:
    - build
  script:
    - cd infra
    - gcloud auth activate-service-account
      --key-file=$GOOGLE_APPLICATION_CREDENTIALS
    - gcloud config set project $PROJECT_ID
    - gcloud auth configure-docker
    - gcloud services enable containerregistry.googleapis.com
    - gcloud services enable run.googleapis.com
    - gcloud services enable cloudbuild.googleapis.com
    - gcloud services enable deploymentmanager.googleapis.com
    - gcloud builds submit --region=us-central1 --config frontend_cloudbuild.yml
    - gcloud beta run services add-iam-policy-binding serverless-frontend
      --region=us-central1 --member=allUsers --role=roles/run.invoker
  only:
    - dev
